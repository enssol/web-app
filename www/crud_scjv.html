<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

<head>
  <title>Create New SCJV Record</title>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <style type="text/css">
    :root {
      --primary-color: #2f4f2f;
      --secondary-color: #4f7f4f;
      --background-color: #f4f7f2;
      --border-color: #ddd;
      --error-color: #ff0000;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--background-color);
      margin: 0;
      padding: 20px;
    }

    .form-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    .form-section {
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      padding: 15px;
    }

    .form-section h3 {
      margin-top: 0;
      color: var(--primary-color);
    }

    .hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      box-sizing: border-box;
    }

    .expand-button {
      width: 100%;
      padding: 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }

    .error {
      color: var(--error-color);
      font-size: 0.9em;
      display: none;
    }

    select.error-field {
      border: 1px solid #ff0000;
    }

    .error-message {
      color: #ff0000;
      font-size: 0.9em;
      display: none;
      margin-top: 5px;
    }
  </style>

  <script type="text/javascript">
    "use strict";

    function getNextObligationNumber(callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/scjv.rec", true);
      xhr.onload = function () {
        if (xhr.status === 200) {
          var records = xhr.responseText.split("\n");
          var maxNum = 0;

          records.forEach(function (line) {
            if (line.indexOf("Obligation_Number: PCEMP-") === 0) {
              var num = parseInt(line.split("-")[1]);
              maxNum = Math.max(maxNum, num);
            }
          });
          callback("PCEMP-" + (maxNum + 1));
        } else {
          callback("PCEMP-1");
        }
      };
      xhr.onerror = function () {
        callback("PCEMP-1");
      };
      xhr.send();
    }

    function expandSection(sectionId) {
      var section = document.getElementById(sectionId);
      if (section) {
        section.style.display = "block";
      }

      var button = document.querySelector('button[onclick="expandSection(\'' + sectionId + '\')"]');
      if (button) {
        button.style.display = "none";
      }
    }

    function validateDropdown(selectElement) {
      var errorId = selectElement.id + "_error";
      var errorElement = document.getElementById(errorId);

      if (!selectElement.value) {
        selectElement.className = "error-field";
        if (errorElement) {
          errorElement.style.display = "block";
        }
        return false;
      }

      selectElement.className = "";
      if (errorElement) {
        errorElement.style.display = "none";
      }
      return true;
    }

    function attachDropdownValidation() {
      var dropdowns = document.getElementsByTagName("select");
      var i;

      for (i = 0; i < dropdowns.length; i++) {
        if (dropdowns[i].getAttribute("required")) {
          dropdowns[i].onchange = function () {
            validateDropdown(this);
          };
        }
      }
    }

    function validateForm(section) {
      var isValid = true;
      var dropdowns = document.querySelectorAll("#" + section + " select[required]");
      var inputs = document.querySelectorAll("#" + section + " input[required], #" + section + " textarea[required]");
      var i;

      for (i = 0; i < dropdowns.length; i++) {
        if (!validateDropdown(dropdowns[i])) {
          isValid = false;
        }
      }

      for (i = 0; i < inputs.length; i++) {
        if (!inputs[i].value) {
          isValid = false;
          var error = document.getElementById(inputs[i].id + "_error");
          if (error) {
            error.style.display = "block";
          }
        }
      }

      return isValid;
    }

    function submitForm() {
      if (!validateForm("stage1") || !validateForm("stage2") || !validateForm("stage3")) {
        alert("Please fill all required fields");
        return;
      }

      var formData = new FormData(document.getElementById("recordForm"));

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/create_record", true);
      xhr.onload = function () {
        if (xhr.status === 200) {
          alert("Record created successfully");
          window.location.href = "scjv.html";
        } else {
          handleServerError(xhr, "Creating record");
        }
      };
      xhr.onerror = function () {
        handleServerError(xhr, "Creating record");
      };
      xhr.send(formData);
    }

    window.onload = function () {
      getNextObligationNumber(function (number) {
        document.getElementById("obligation_number").value = number;
      });
      attachDropdownValidation();
    };

    function handleServerError(error, context) {
      var errorDiv = document.getElementById('record-error');
      if (!errorDiv) return;

      var message = 'Operation failed';
      switch(error.status) {
          case 403:
              message = 'Permission denied';
              break;
          case 404:
              message = 'Record not found';
              break;
          case 500:
              message = 'Server error';
              break;
      }

      errorDiv.innerHTML = context + ': ' + message;
      errorDiv.style.display = 'block';
      setTimeout(function() {
          errorDiv.style.display = 'none';
      }, 5000);
    }

    function validateRecordData(formData, projectPrefix) {
      var errors = [];
      var obligationNum = formData.get('obligation_number');
      var projectPhase = formData.get('project_phase');
      var actionDueDate = formData.get('action_due_date');

      if (!obligationNum || !obligationNum.startsWith(projectPrefix)) {
          errors.push('Obligation Number must start with ' + projectPrefix);
      }

      if (!projectPhase) {
          errors.push('Project Phase is required');
      }

      if (!actionDueDate) {
          errors.push('Action Due Date is required');
      }

      return errors;
    }

    function validateAndSaveRecord(projectPrefix) {
      var formData = new FormData(document.getElementById('recordForm'));
      var errors = validateRecordData(formData, projectPrefix);

      if (errors.length > 0) {
          var errorDiv = document.getElementById('record-error');
          errorDiv.innerHTML = errors.join('<br>');
          errorDiv.style.display = 'block';
          return false;
      }

      return true;
    }

    // Add to all pages that load records
    "use strict";

    function parseRecordData(data, projectFilter) {
        var records = [];
        var currentRecord = {};
        var lines = data.split('\n');

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();

            if (!line || line.startsWith('%')) {
                continue;
            }

            var colonIndex = line.indexOf(':');
            if (colonIndex > -1) {
                var field = line.substring(0, colonIndex).trim();
                var value = line.substring(colonIndex + 1).trim();

                if (field === 'Project_Name') {
                    if (Object.keys(currentRecord).length > 0) {
                        records.push(currentRecord);
                    }
                    currentRecord = {};
                }
                currentRecord[field] = value;
            }
        }

        if (Object.keys(currentRecord).length > 0) {
            records.push(currentRecord);
        }

        return records.filter(function(record) {
            return record.Project_Name === projectFilter;
        });
    }
  </script>
</head>

<body>
  <div class="form-container">
    <h2>Create New SCJV Record</h2>
    <div id="record-error" class="error-message"></div>
    <form id="recordForm" onsubmit="return false;">
      <!-- Stage 1: Basic Information -->
      <div id="stage1" class="form-section">
        <h3>Basic Information</h3>

        <div class="form-group">
          <label for="obligation_number">Obligation Number</label>
          <input type="text" id="obligation_number" name="obligation_number" readonly>
        </div>

        <div class="form-group">
          <label for="project_name">Project Name</label>
          <input type="text" id="project_name" name="project_name" value="SCJV - Pilbara Ports" readonly>
        </div>

        <div class="form-group">
          <label for="primary_env_mechanism">Primary Environmental Mechanism</label>
          <select id="primary_env_mechanism" name="primary_env_mechanism" required>
            <option value="">Select Mechanism</option>
            <option value="Portside CEMP">Portside CEMP</option>
            <option value="MS1180">MS1180</option>
            <option value="EPBC 2018/8383">EPBC 2018/8383</option>
          </select>
          <span id="primary_env_mechanism_error" class="error-message">Please select a mechanism</span>
        </div>

        <div class="form-group">
          <label for="procedure">Procedure</label>
          <select id="procedure" name="procedure" required>
            <option value="">Select Procedure</option>
            <option value="PPA requirement">PPA requirement</option>
            <option value="Cultural Heritage Management Plan">Cultural Heritage Management Plan</option>
            <option value="Portside CEMP">Portside CEMP</option>
          </select>
          <span id="procedure_error" class="error-message">Please select a procedure</span>
        </div>

        <div class="form-group">
          <label for="environmental_aspect">Environmental Aspect</label>
          <select id="environmental_aspect" name="environmental_aspect" required>
            <option value="">Select Aspect</option>
            <option value="Administration">Administration</option>
            <option value="Cultural Heritage Management">Cultural Heritage Management</option>
            <option value="Terrestrial Fauna Management">Terrestrial Fauna Management</option>
            <option value="Dust Management">Dust Management</option>
          </select>
          <span id="environmental_aspect_error" class="error-message">Please select an aspect</span>
        </div>

        <button type="button" class="expand-button" onclick="expandSection('stage2')">
          Next: Action Details
        </button>
      </div>

      <!-- Stage 2: Action Details -->
      <div id="stage2" class="form-section hidden">
        <h3>Action Details</h3>

        <!-- Add action detail fields -->
        <div class="form-group">
          <label for="obligation">Obligation</label>
          <textarea id="obligation" name="obligation" required></textarea>
          <div id="obligation_error" class="error">Required field</div>
        </div>

        <div class="form-group">
          <label for="accountability">Accountability</label>
          <select id="accountability" name="accountability" required>
            <option value="">Select Accountability</option>
            <option value="SCJV">SCJV</option>
            <option value="SCJV - during construction">SCJV - during construction</option>
            <option value="SCJV - during construction + Perdaman - during operations">SCJV - during construction +
              Perdaman - during operations</option>
            <option value="Perdaman">Perdaman</option>
          </select>
          <div id="accountability_error" class="error">Required field</div>
        </div>

        <div class="form-group">
          <label for="responsibility">Responsibility</label>
          <select id="responsibility" name="responsibility" required>
            <option value="">Select Responsibility</option>
            <option value="SCJV - HSSE Manager">SCJV - HSSE Manager</option>
            <option value="SCJV - Environmental Lead">SCJV - Environmental Lead</option>
            <option value="SCJV - Lead Environmental Advisor">SCJV - Lead Environmental Advisor</option>
            <option value="SCJV - Project Environmental Representative">SCJV - Project Environmental Representative
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="project_phase">Project Phase</label>
          <select id="project_phase" name="project_phase" required>
            <option value="">Select Phase</option>
            <option value="Design and Construction">Design and Construction</option>
            <option value="During Construction">During Construction</option>
            <option value="Throughout the project">Throughout the project</option>
          </select>
        </div>

        <div class="form-group">
          <label for="action_due_date">Action Due Date</label>
          <input type="date" id="action_due_date" name="action_due_date" required>
        </div>

        <button type="button" class="expand-button" onclick="expandSection('stage3')">
          Next: Supporting Information
        </button>
      </div>

      <!-- Stage 3: Supporting Information -->
      <div id="stage3" class="form-section hidden">
        <h3>Supporting Information</h3>

        <!-- Add supporting info fields -->
        <div class="form-group">
          <label for="supporting_info">Supporting Information</label>
          <textarea id="supporting_info" name="supporting_info"></textarea>
        </div>

        <div class="form-group">
          <label for="recurring">Recurring Obligation</label>
          <select id="recurring" name="recurring_obligation">
            <option value="No">No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>

        <div class="form-group">
          <label for="inspection">Inspection Required</label>
          <select id="inspection" name="inspection">
            <option value="No">No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>

        <div class="form-group">
          <label for="site_or_desktop">Site or Desktop</label>
          <select id="site_or_desktop" name="site_or_desktop">
            <option value="Site">Site</option>
            <option value="Desktop">Desktop</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status" required>
            <option value="Not Started">Not Started</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
        </div>

        <button type="button" class="expand-button" onclick="submitForm()">
          Create Record
        </button>
      </div>
    </form>
  </div>
</body>

</html>
